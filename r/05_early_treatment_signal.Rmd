---
title: "05_early_treatment_signal.Rmd"
output: html_notebook
---

## Objective

The goal of this phase is to evaluate whether early on-treatment information provides additional predictive signal beyond what is available at enrollment. While previous analyses show that baseline characteristics alone have limited ability to identify responders, it remains possible that early changes after treatment initiation may offer actionable insight.

This phase focuses on determining whether simple, interpretable features derived from the first on-treatment visit meaningfully improve the identification of eventual responders. Rather than pursuing full longitudinal modeling, the intent is to assess whether early treatment response metrics could realistically support adaptive decision-making during an ongoing study.

## Modeling Question

Can early on-treatment changes, observed within the first study visit, meaningfully improve prediction of response compared to enrollment-time data alone?

## Data Scope

This analysis is intentionally limited to information that would plausibly be available early in an ongoing trial:

Baseline patient characteristics (as defined in prior phases)

Measurements from the first on-treatment visit only

Later visits and aggregate longitudinal outcomes are explicitly excluded to prevent data leakage and to preserve a realistic decision context.

## Comparison Strategy

Two models are evaluated using identical train/test splits and evaluation procedures:

- model_a — Reference baseline model using enrollment-time attributes only
- model_e — Baseline model augmented with early on-treatment features derived from the first visit
  - model_a + t1_days, delta_severity (t0-t1), rate_severity (delta_severity/t1_days), delta_crp, rate_crp, delta_alt, rate_alt, delta_egfr, rate_egfr, med_adherence_v1

Early on-treatment features include simple deltas and summary measures (e.g., change from baseline, early adherence) selected for interpretability and clinical plausibility.

This comparison is designed to quantify the incremental value of early treatment data rather than to optimize absolute model performance.

## Evaluation Criteria

Models are evaluated using the same metrics established in prior phases. Due to the low prevalence of response, precision–recall AUC is the primary evaluation metric, with ROC–AUC used for context. Performance differences are interpreted in terms of decision utility and feasibility, rather than as absolute improvements in predictive accuracy.

## Interpretation Focus

Results are interpreted through a decision-oriented lens, addressing whether early on-treatment data provides sufficient signal to justify adaptive trial strategies such as early monitoring, prioritization, or intervention.

## Libraries Needed

```{r}
library(caret)
library(pROC)
library(PRROC)
library(RSQLite)
library(dplyr)
```

## Code needed from 02_baesline_EDA and 03_baseline_modeling

```{r}
conn <- dbConnect(SQLite(), "clinical_trial.db")

patients <- dbGetQuery(conn, "SELECT * FROM patients;")
sites    <- dbGetQuery(conn, "SELECT * FROM sites;")
outcomes <- dbGetQuery(conn, "SELECT * FROM outcomes;")
visits <- dbGetQuery(conn, "SELECT * FROM visits WHERE visit_num = 1")

dup_visits <- visits %>%
  count(patient_id) %>%
  filter(n > 1)

if (nrow(dup_visits) == 0) {
  message("Uniqueness check passed: one visit_num == 1 per patient.")
} else {
  stop("Uniqueness check FAILED: multiple visit_num == 1 records detected.")
}

phase5_df <- patients %>%
  inner_join(
    outcomes %>% select(patient_id, responder_30pct),
    by = "patient_id") %>%
  inner_join(
    visits %>% 
      select(patient_id, 
             t1_days = days_from_enroll, 
             med_adherence_v1 = med_adherence, 
             severity_v1 = severity_score, 
             crp_mgL_v1 =  crp_mgL, 
             alt_U_L_v1 = alt_U_L, 
             egfr_ml_min_v1 = egfr_ml_min
             ),
    by = "patient_id"
  ) %>%
  select(
    responder_30pct,
    treatment_arm,
    sex,
    age,
    bmi,
    smoker,
    comorbidity_count,
    baseline_severity,
    crp_mgL,
    alt_U_L,
    egfr_ml_min,
    self_reported_adherence,
    t1_days,
    med_adherence_v1,
    severity_v1,
    crp_mgL_v1,
    alt_U_L_v1,
    egfr_ml_min_v1
  ) %>%
  mutate(
    t1_days = pmax(t1_days, 1),
    delta_severity = severity_v1 - baseline_severity,
    rate_severity = delta_severity / t1_days,
    delta_crp = crp_mgL_v1 - crp_mgL,
    rate_crp = delta_crp / t1_days,
    delta_alt = alt_U_L_v1 - alt_U_L, 
    rate_alt = delta_alt / t1_days, 
    delta_egfr = egfr_ml_min_v1 - egfr_ml_min, 
    rate_egfr = delta_egfr / t1_days
  )

set.seed(123) 

train_idx <- createDataPartition(
  phase5_df$responder_30pct,
  p = 0.8,
  list = FALSE
)

train_df <- phase5_df[train_idx, ]
test_df  <- phase5_df[-train_idx, ]

train_df$sex <- factor(train_df$sex)
test_df$sex  <- factor(test_df$sex, 
                       levels = levels(train_df$sex))

train_df$treatment_arm <- factor(train_df$treatment_arm)
test_df$treatment_arm  <- factor(test_df$treatment_arm, 
                                 levels = levels(train_df$treatment_arm)
                                 )

```

```{r}
prop.table(table(phase5_df$responder_30pct))
prop.table(table(train_df$responder_30pct))
prop.table(table(test_df$responder_30pct))
```

I tested the distribution again just to confirm that everything looks right. Using the same seed should have ensured that I got the same datasets as in 03_baseline_modeling but it is good to check. 

## model_a

```{r}
model_a <- glm(formula = responder_30pct ~ 
               as.factor(sex) + 
               age + 
               bmi +
               smoker +
               comorbidity_count +
               baseline_severity +
               crp_mgL + 
               alt_U_L +
               egfr_ml_min +
               self_reported_adherence +
               treatment_arm, 
             family=binomial(link='logit'), 
             data=train_df)
summary(model_a)
```

```{r}
test_pred_prob <- predict(model_a, newdata = test_df, type = "response")
summary(test_pred_prob)
head(test_pred_prob)
```

```{r}
roc_obj <- roc(
  response = test_df$responder_30pct,
  predictor = test_pred_prob
)

auc(roc_obj)
```

```{r}
pr_obj <- pr.curve(
  scores.class0 = test_pred_prob[test_df$responder_30pct == 1],
  scores.class1 = test_pred_prob[test_df$responder_30pct == 0],
  curve = TRUE
)

pr_obj$auc.integral
```

## model_e

```{r}
model_e <- glm(formula = responder_30pct ~ 
               as.factor(sex) + 
               age + 
               bmi +
               smoker +
               comorbidity_count +
               baseline_severity +
               crp_mgL + 
               alt_U_L +
               egfr_ml_min +
               self_reported_adherence +
               treatment_arm +
               med_adherence_v1 +
               delta_severity +
               rate_severity +
               delta_crp +
               rate_crp +
               delta_alt +
               rate_alt +
               delta_egfr +
               rate_egfr,
             family=binomial(link='logit'), 
             data=train_df)
summary(model_e)
```

```{r}
test_pred_prob <- predict(model_a, newdata = test_df, type = "response")
summary(test_pred_prob)
head(test_pred_prob)
```

```{r}
roc_obj <- roc(
  response = test_df$responder_30pct,
  predictor = test_pred_prob
)

auc(roc_obj)
```

```{r}
pr_obj <- pr.curve(
  scores.class0 = test_pred_prob[test_df$responder_30pct == 1],
  scores.class1 = test_pred_prob[test_df$responder_30pct == 0],
  curve = TRUE
)

pr_obj$auc.integral
```

Augmenting the baseline model with early on-treatment features derived from the first follow-up visit did not improve predictive performance. After controlling for baseline disease severity and treatment assignment, early changes in clinical severity and laboratory values did not demonstrate independent predictive value, and model complexity increased without improvement in fit. These results suggest that meaningful response signal emerges later in the treatment course, and that baseline severity remains the dominant predictor during the earliest phase of treatment.




